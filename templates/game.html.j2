<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ game.title or slug }}</title>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #000;
    }
    canvas {
          border: 2px solid var(--accent);
    display: block;
    background: #000000;
    height: auto;
    aspect-ratio: 1000 / 800;
    image-rendering: pixelated;
    outline: none;
    width: 100%;
    box-sizing:inherit;
    
    }
    .canvas-container {
      width: 100%;
      max-width: 1000px;
      flex-grow: 1;
      box-sizing: border-box;
      padding: 10px;
    }
  </style>
</head>
<body>
<div class="canvas-container">
  <canvas id="canvas" width="1000" height="800" tabindex="0"></canvas>
</div>
  <script type="module">
  import { webEngine } from "https://esm.sh/sprig@1/web";

  async function start() {
    const canvas = document.getElementById('canvas');
    const game = webEngine(canvas);
    await Promise.resolve();

    // try a couple times to avoid initial race
    for (let i = 0; i < 3; i++) {
      try {
        const r = await fetch(`/games/{{ slug }}.js`);
        if (!r.ok) throw new Error('status ' + r.status);
        const code = await r.text();
        const fn = new Function(...Object.keys(game.api), code);
        fn(...Object.values(game.api));
        canvas.focus();
        return;
      } catch (e) {
        await new Promise(res => setTimeout(res, 120 * (i + 1)));
      }
    }

    console.error('Failed to load /games/{{ slug }}.js after retries');
  }

  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', start);
  } else {
    start();
  }
</script>

  <script type="module">
    import { webEngine } from "https://esm.sh/sprig@1/web";

    const canvas = document.getElementById("canvas");
    const game = webEngine(canvas);

    fetch(`/games/{{ slug }}.js`)
      .then(r => r.text())
      .then(code => {
        const fn = new Function(...Object.keys(game.api), code);
        fn(...Object.values(game.api));
        canvas.focus();
      });

    document.addEventListener('click', () => canvas.focus());
  </script>
</body>
</html>
